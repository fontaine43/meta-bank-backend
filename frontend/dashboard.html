<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Meta Bank Dashboard</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background-color: #f4f6f9;
      display: flex;
      min-height: 100vh;
    }
    .sidebar {
      width: 250px;
      background-color: #006644;
      color: white;
      height: 100vh;
      padding: 20px;
      box-sizing: border-box;
      position: fixed;
      left: 0;
      top: 0;
      overflow-y: auto;
    }
    .sidebar h2 {
      margin-top: 0;
      font-size: 1.5em;
      margin-bottom: 30px;
      text-align: center;
    }
    .sidebar a {
      display: block;
      color: white;
      text-decoration: none;
      margin-bottom: 15px;
      font-weight: 500;
      padding: 10px 15px;
      border-radius: 6px;
      transition: background-color 0.3s;
    }
    .sidebar a:hover { background-color: #004d33; text-decoration: none; }
    .sidebar a.active { background-color: #004d33; }

    .main {
      flex: 1;
      padding: 30px;
      background: linear-gradient(to bottom right, #ffffff, #e0f7e9);
      margin-left: 250px;
      width: calc(100% - 250px);
    }
    .greeting {
      font-size: 1.8em;
      margin-bottom: 5px;
      color: #006644;
      font-weight: 600;
    }
    .clock {
      font-size: 1em;
      margin-bottom: 15px;
      color: #666;
    }
    .welcome {
      font-size: 1.1em;
      margin-bottom: 10px;
      color: #333;
    }

    .alert {
      padding: 15px;
      border-radius: 6px;
      margin: 15px 0;
      text-align: center;
      font-weight: 500;
      display: none;
    }
    .alert-error { background-color: #ffeaea; color: #d63031; border: 1px solid #ffcccc; }
    .alert-success { background-color: #e8f8ef; color: #006644; border: 1px solid #b8e6b8; }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      text-align: center;
    }
    .stat-value {
      font-size: 1.8em;
      font-weight: 600;
      color: #006644;
      margin: 10px 0;
    }
    .stat-label { color: #666; font-size: 0.9em; }

    .account-info, .transactions, .transfers, .analytics {
      background-color: white;
      padding: 25px;
      margin-bottom: 30px;
      border-radius: 12px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    .account-info h3, .transactions h3, .transfers h3, .analytics h3 {
      margin-top: 0;
      color: #006644;
      font-size: 1.3em;
      margin-bottom: 20px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      padding: 12px 15px;
      border-bottom: 1px solid #eee;
      text-align: left;
    }
    th {
      background-color: #e0f7e9;
      color: #006644;
      font-weight: 600;
    }

    .restriction-note {
      font-size: 0.9em;
      color: #888;
      margin-top: 15px;
      font-style: italic;
    }

    .flex-row {
      display: flex;
      gap: 30px;
      flex-wrap: wrap;
    }
    .analytics { flex: 1; min-width: 300px; }
    .transfers { flex: 2; min-width: 400px; }
    .analytics p { margin: 12px 0; font-size: 1em; }
    canvas { margin-top: 20px; }
  </style>
</head>
<body>

<div class="sidebar">
  <h2>Meta Bank</h2>
  <a href="dashboard.html" class="active">Dashboard</a>
  <a href="overview.html">Overview</a>
  <a href="verification.html">Verification</a>
  <a href="profile.html">Profile</a>
  <a href="loan.html">Loans</a>
  <a href="investments.html">Investments</a>
  <a href="ira.html">IRA</a>
  <a href="transfer.html">Transfer</a>
  <a href="external-accounts.html">External Accounts</a>
  <a href="statements.html">Statements</a>
  <a href="business-account.html">Business Account</a>
  <a href="#" id="signOutLink">Sign Out</a>
</div>

<div class="main">
  <div class="greeting" id="greeting">Loading...</div>
  <div class="clock" id="clock">Loading US Pacific Time...</div>
  <div class="welcome">Welcome back to your dashboard. Hereâ€™s a quick look at your account activity.</div>

  <div id="alertMessage" class="alert"></div>

  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-label">Total Balance</div>
      <div class="stat-value" id="totalBalance">$0.00</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Available Balance</div>
      <div class="stat-value" id="availableBalance">$0.00</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Account Status</div>
      <div class="stat-value" id="accountStatus">-</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">KYC Status</div>
      <div class="stat-value" id="kycStatus">-</div>
    </div>
  </div>

  <div class="account-info">
    <h3>Your Accounts</h3>
    <table id="accountTable">
      <tr>
        <th>Account Type</th>
        <th>Bank</th>
        <th>Account Number</th>
        <th>Routing Number</th>
        <th>Balance</th>
        <th>Available Balance</th>
      </tr>
      <tr>
        <td colspan="6" style="text-align: center; padding: 40px;">Loading account information...</td>
      </tr>
    </table>
    <div class="restriction-note">ðŸ”’ Available Balance may be restricted due to pending verification or transfer limits.</div>
  </div>

  <div class="transactions">
    <h3>Recent Transactions</h3>
    <table id="transactionsTable">
      <tr><th>Date</th><th>Description</th><th>Type</th><th>Amount</th></tr>
      <tr><td colspan="4" style="text-align: center; padding: 30px;">Loading transactions...</td></tr>
    </table>
  </div>

  <div class="flex-row">
    <div class="transfers">
      <h3>Recent Transfers</h3>
      <table id="transfersTable">
        <tr><th>Date</th><th>Type</th><th>To Account</th><th>Amount</th><th>Status</th></tr>
        <tr><td colspan="5" style="text-align: center; padding: 30px;">Loading transfers...</td></tr>
      </table>
    </div>
    <div class="analytics">
      <h3>Account Analytics</h3>
      <p><strong>Total Deposits:</strong> <span id="totalDeposits">$0.00</span></p>
      <p><strong>Total Withdrawals:</strong> <span id="totalWithdrawals">$0.00</span></p>
      <p><strong>Net Growth:</strong> <span id="netGrowth">$0.00</span></p>
      <p><strong>Last Login:</strong> <span id="lastLogin">Loading...</span></p>
      <canvas id="analyticsChart" width="300" height="200"></canvas>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// API Base URL (localhost in dev, /api in production)
const API_BASE =
  (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1')
    ? 'http://localhost:5000/api'
    : 'https://meta-bank-backend.onrender.com/api';


function showAlert(message, type = 'error') {
  const el = document.getElementById('alertMessage');
  el.textContent = message;
  el.className = `alert alert-${type}`;
  el.style.display = 'block';
  if (type === 'success') {
    setTimeout(() => { el.style.display = 'none'; }, 4000);
  }
}

function formatUSD(amount) {
  return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount || 0);
}

function getUSGreeting(name) {
  const now = new Date();
  const options = { timeZone: 'America/Los_Angeles', hour: 'numeric', hour12: false };
  const pacificHour = parseInt(new Intl.DateTimeFormat('en-US', options).format(now), 10);
  if (pacificHour < 12) return `Good Morning, ${name}!`;
  if (pacificHour < 18) return `Good Afternoon, ${name}!`;
  return `Good Evening, ${name}!`;
}

function updateClock() {
  const now = new Date();
  const options = {
    timeZone: 'America/Los_Angeles',
    hour: 'numeric', minute: 'numeric', second: 'numeric', hour12: true
  };
  document.getElementById('clock').textContent =
    "Current US Pacific Time: " + new Intl.DateTimeFormat('en-US', options).format(now);
}
setInterval(updateClock, 1000);
updateClock();

document.getElementById('signOutLink').addEventListener('click', (e) => {
  e.preventDefault();
  localStorage.clear();
  window.location.href = 'login.html';
});

async function loadDashboard() {
  const token = localStorage.getItem('metaBankToken');
  if (!token) {
    showAlert('Session expired. Please log in again.');
    setTimeout(() => window.location.href = 'login.html', 1500);
    return;
  }

  try {
    const res = await fetch(`${API_BASE}/user/dashboard`, {
      headers: {
        'Authorization': 'Bearer ' + token,
        'Content-Type': 'application/json'
      }
    });
    const data = await res.json();

    if (!res.ok || !data.success) {
      showAlert(data.message || 'Failed to load dashboard');
      return;
    }

    // Greeting
    document.getElementById('greeting').textContent =
      getUSGreeting(data.fullName || data.username || 'User');

    // Stats
    document.getElementById('accountStatus').textContent = data.accountStatus || 'Inactive';
    document.getElementById('kycStatus').textContent = (data.kycStatus || 'Pending');

    // Balances
    document.getElementById('totalBalance').textContent = formatUSD(data.balance);
    document.getElementById('availableBalance').textContent = formatUSD(data.availableBalance);

    // Accounts table
    const accounts = data.accounts && Array.isArray(data.accounts) ? data.accounts : [{
      accountType: data.accountType || 'Checking',
      bankName: data.bankName || 'Meta Bank',
      accountNumber: data.accountNumber || 'Not assigned',
      routingNumber: data.routingNumber || 'N/A',
      balance: data.balance || 0,
      availableBalance: data.availableBalance || 0,
    }];

    let accountHTML = `
      <tr>
        <th>Account Type</th>
        <th>Bank</th>
        <th>Account Number</th>
        <th>Routing Number</th>
        <th>Balance</th>
        <th>Available Balance</th>
      </tr>
    `;
    accountHTML += accounts.map(acc => `
      <tr>
        <td>${acc.accountType}</td>
        <td>${acc.bankName}</td>
        <td>${acc.accountNumber}</td>
        <td>${acc.routingNumber}</td>
        <td>${formatUSD(acc.balance)}</td>
        <td>${formatUSD(acc.availableBalance)}</td>
      </tr>
    `).join('');
    document.getElementById('accountTable').innerHTML = accountHTML;

    // Transactions
    const txns = data.transactions || [];
    let txHTML = `<tr><th>Date</th><th>Description</th><th>Type</th><th>Amount</th></tr>`;
    txHTML += (txns.length ? txns : []).map(t => `
      <tr>
        <td>${t.date ? new Date(t.date).toLocaleDateString() : 'â€”'}</td>
        <td>${t.description || 'â€”'}</td>
        <td>${t.type || 'â€”'}</td>
        <td>${formatUSD(t.amount)}</td>
      </tr>
    `).join('') || `<tr><td colspan="4" style="text-align:center;padding:30px;">No transactions</td></tr>`;
    document.getElementById('transactionsTable').innerHTML = txHTML;

    // Transfers
    const transfers = data.transfers || [];
    let tfHTML = `<tr><th>Date</th><th>Type</th><th>To Account</th><th>Amount</th><th>Status</th></tr>`;
    tfHTML += (transfers.length ? transfers : []).map(t => `
      <tr>
        <td>${t.date ? new Date(t.date).toLocaleDateString() : 'â€”'}</td>
        <td>${t.type || 'â€”'}</td>
        <td>${t.toAccount || 'â€”'}</td>
        <td>${formatUSD(t.amount)}</td>
        <td>${t.status || 'â€”'}</td>
      </tr>
    `).join('') || `<tr><td colspan="5" style="text-align:center;padding:30px;">No transfers</td></tr>`;
    document.getElementById('transfersTable').innerHTML = tfHTML;

    // Analytics section
    document.getElementById('totalDeposits').textContent = formatUSD(data.analytics?.totalDeposits || 0);
    document.getElementById('totalWithdrawals').textContent = formatUSD(data.analytics?.totalWithdrawals || 0);
    const net = (data.analytics?.totalDeposits || 0) - (data.analytics?.totalWithdrawals || 0);
    document.getElementById('netGrowth').textContent = formatUSD(net);
    document.getElementById('lastLogin').textContent =
      data.lastLogin ? new Date(data.lastLogin).toLocaleString() : 'â€”';

    // Chart
    const ctx = document.getElementById('analyticsChart').getContext('2d');
    const chartData = data.analytics?.history || [];
    new Chart(ctx, {
      type: 'line',
      data: {
        labels: chartData.map(p => p.label || ''),
        datasets: [{
          label: 'Balance',
          data: chartData.map(p => p.balance || 0),
          borderColor: '#006644',
          backgroundColor: 'rgba(0,102,68,0.1)',
          tension: 0.2
        }]
      },
      options: { responsive: true, plugins: { legend: { display: true } } }
    });

  } catch (err) {
    console.error('Dashboard fetch error:', err);
    showAlert('Error connecting to server');
  }
}

document.addEventListener('DOMContentLoaded', loadDashboard);
</script>
</body>
</html>
