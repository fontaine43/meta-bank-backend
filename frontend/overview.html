<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Meta Bank Overview</title>
  <style>
    * { box-sizing: border-box; }
    body { 
      margin:0; 
      font-family:'Segoe UI',sans-serif; 
      background-color:#f4f6f9; 
      display:flex; 
      min-height: 100vh;
    }
    .sidebar { 
      width:250px; 
      background-color:#006644; 
      color:white; 
      height:100vh; 
      padding:20px; 
      box-sizing:border-box; 
      position: fixed;
      left: 0;
      top: 0;
    }
    .sidebar h2 { 
      margin-top:0; 
      font-size:1.5em; 
      margin-bottom:30px; 
      text-align: center;
    }
    .sidebar a { 
      display:block; 
      color:white; 
      text-decoration:none; 
      margin-bottom:15px; 
      font-weight:500; 
      padding: 10px 15px;
      border-radius: 6px;
      transition: background-color 0.3s;
    }
    .sidebar a:hover { 
      background-color: #004d33;
      text-decoration: none;
    }
    
    .sidebar a.active {
      background-color: #004d33;
    }
    
    .main { 
      flex:1; 
      padding:30px; 
      background:linear-gradient(to bottom right,#ffffff,#e0f7e9); 
      margin-left: 250px;
      width: calc(100% - 250px);
    }
    .greeting { 
      font-size:1.8em; 
      margin-bottom:20px; 
      color:#006644; 
      font-weight: 600;
    }
    .overview-box, .activity-box, .quick-actions { 
      background-color:white; 
      padding:25px; 
      border-radius:12px; 
      box-shadow:0 5px 15px rgba(0,0,0,0.1); 
      margin-bottom:30px; 
    }
    .overview-box h3, .activity-box h3, .quick-actions h3 { 
      margin-top:0; 
      color:#006644; 
      font-size: 1.3em;
      margin-bottom: 20px;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      text-align: center;
      border-left: 4px solid #006644;
    }
    
    .stat-value {
      font-size: 1.8em;
      font-weight: 600;
      color: #006644;
      margin: 10px 0;
    }
    
    .stat-label {
      color: #666;
      font-size: 0.9em;
    }
    
    table { 
      width:100%; 
      border-collapse:collapse; 
      margin-top:10px; 
    }
    th, td { 
      padding:12px 15px; 
      border-bottom:1px solid #eee; 
      text-align:left; 
    }
    th { 
      background-color:#e0f7e9; 
      color:#006644; 
      font-weight: 600;
    }
    
    .account-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .detail-item {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      border-left: 4px solid #006644;
    }
    
    .detail-label {
      font-size: 0.9em;
      color: #666;
      margin-bottom: 5px;
    }
    
    .detail-value {
      font-size: 1.1em;
      font-weight: 600;
      color: #333;
    }
    
    .quick-actions-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }
    
    .action-button {
      background: #006644;
      color: white;
      border: none;
      padding: 15px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: background-color 0.3s;
      text-align: center;
    }
    
    .action-button:hover {
      background: #004d33;
    }
    
    .alert {
      padding: 12px 15px;
      border-radius: 6px;
      margin-bottom: 20px;
      text-align: center;
      font-weight: 500;
    }
    
    .alert-error {
      background-color: #ffeaea;
      color: #d63031;
      border: 1px solid #ffcccc;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    
    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.8em;
      font-weight: 600;
      margin-left: 10px;
    }
    
    .status-active {
      background-color: #e8f8ef;
      color: #006644;
    }
    
    .status-pending {
      background-color: #fff3cd;
      color: #856404;
    }
  </style>
</head>
<body>

<div class="sidebar">
  <h2>Meta Bank</h2>
  <a href="dashboard.html">Dashboard</a>
  <a href="overview.html" class="active">Overview</a>
  <a href="verification.html">Verification</a>
  <a href="profile.html">Profile</a>
  <a href="loan.html">Loans</a>
  <a href="investments.html">Investments</a>
  <a href="ira.html">IRA</a>
  <a href="transfer.html">Transfer</a>
  <a href="external-accounts.html">External Accounts</a>
  <a href="statements.html">Statements</a>
  <a href="business-account.html">Business Account</a>
  <a href="#" id="signOutLink">Sign Out</a>
</div>

<div class="main">
  <div class="greeting">Loading Account Overview...</div>
  
  <div id="alertMessage" class="alert" style="display: none;"></div>

  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-label">Total Balance</div>
      <div class="stat-value" id="totalBalance">$0.00</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Available Balance</div>
      <div class="stat-value" id="availableBalance">$0.00</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Account Status</div>
      <div class="stat-value" id="accountStatus">-</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">KYC Status</div>
      <div class="stat-value" id="kycStatus">-</div>
    </div>
  </div>

  <div class="quick-actions">
    <h3>Quick Actions</h3>
    <div class="quick-actions-grid">
      <button class="action-button" onclick="location.href='transfer.html'">
        üí∏ Transfer Money
      </button>
      <button class="action-button" onclick="location.href='loan.html'">
        üè¶ Apply for Loan
      </button>
      <button class="action-button" onclick="location.href='investments.html'">
        üìà Make Investment
      </button>
      <button class="action-button" onclick="location.href='external-accounts.html'">
        üîó Link Account
      </button>
      <button class="action-button" onclick="location.href='statements.html'">
        üìÑ View Statements
      </button>
      <button class="action-button" onclick="location.href='profile.html'">
        üë§ Update Profile
      </button>
    </div>
  </div>

  <div class="overview-box">
    <h3>Account Details</h3>
    <div class="account-details">
      <div class="detail-item">
        <div class="detail-label">Account Number</div>
        <div class="detail-value" id="accountNumber">Loading...</div>
      </div>
      <div class="detail-item">
        <div class="detail-label">Routing Number</div>
        <div class="detail-value" id="routingNumber">Loading...</div>
      </div>
      <div class="detail-item">
        <div class="detail-label">Account Type</div>
        <div class="detail-value" id="accountType">Loading...</div>
      </div>
      <div class="detail-item">
        <div class="detail-label">Bank Name</div>
        <div class="detail-value" id="bankName">Loading...</div>
      </div>
      <div class="detail-item">
        <div class="detail-label">Member Since</div>
        <div class="detail-value" id="memberSince">Loading...</div>
      </div>
      <div class="detail-item">
        <div class="detail-label">Last Login</div>
        <div class="detail-value" id="lastLogin">Loading...</div>
      </div>
    </div>
  </div>
  
  <div class="activity-box">
    <h3>Recent Activity</h3>
    <table id="activityTable">
      <tr>
        <th>Date</th>
        <th>Description</th>
        <th>Type</th>
        <th>Amount</th>
        <th>Status</th>
      </tr>
      <tr>
        <td colspan="5" style="text-align: center; padding: 30px;">Loading activity...</td>
      </tr>
    </table>
  </div>
</div>

<script>
// API Base URL (localhost in dev, /api in production)
const API_BASE =
  (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1')
    ? 'http://localhost:5000/api'
    : 'https://meta-bank-backend.onrender.com/api';

function showAlert(message, type = 'error') {
  const alertEl = document.getElementById('alertMessage');
  alertEl.textContent = message;
  alertEl.className = `alert alert-${type}`;
  alertEl.style.display = 'block';
}

// Sign out functionality
document.getElementById('signOutLink').addEventListener('click', e => {
  e.preventDefault();
  localStorage.clear();
  window.location.href = 'login.html';
});

async function loadOverview() {
  const token = localStorage.getItem('metaBankToken');
  if (!token) {
    showAlert('Session expired. Please log in again.');
    setTimeout(() => window.location.href = 'login.html', 2000);
    return;
  }
  
  try {
    // Load profile for user info
    const profileResponse = await fetch(`${API_BASE}/auth/profile`, {
      headers: { 
        'Authorization': 'Bearer ' + token,
        'Content-Type': 'application/json'
      }
    });
    
    const profileData = await profileResponse.json();
    
    if (profileResponse.ok && profileData.success) {
      const user = profileData.user;
      const name = user.fullName || user.username || 'User';
      document.querySelector('.greeting').textContent = `Welcome ‚Äì ${name}`;
      
      // Update account details
      document.getElementById('accountNumber').textContent = user.accountNumber || 'Not assigned';
      document.getElementById('routingNumber').textContent = user.routingNumber || 'N/A';
      document.getElementById('accountType').textContent = user.accountType ? user.accountType.charAt(0).toUpperCase() + user.accountType.slice(1) : 'Checking';
      document.getElementById('bankName').textContent = user.bankName || 'Meta Bank';
      document.getElementById('memberSince').textContent = user.createdAt ? new Date(user.createdAt).toLocaleDateString() : 'N/A';
      document.getElementById('lastLogin').textContent = user.lastLogin ? new Date(user.lastLogin).toLocaleString() : 'Current session';
    }

    // Load dashboard for summary data
    const dashboardResponse = await fetch(`${API_BASE}/user/dashboard`, {
      headers: { 
        'Authorization': 'Bearer ' + token,
        'Content-Type': 'application/json'
      }
    });
    
    const data = await dashboardResponse.json();
    
    if (dashboardResponse.ok && data.success) {
      // Format currency
      const formatCurrency = (amount) => {
        return new Intl.NumberFormat('en-US', {
          style: 'currency',
          currency: 'USD'
        }).format(amount || 0);
      };

      // Update balances and status
      document.getElementById('totalBalance').textContent = formatCurrency(data.balance);
      document.getElementById('availableBalance').textContent = formatCurrency(data.availableBalance);
      document.getElementById('accountStatus').textContent = data.accountStatus || 'Inactive';
      document.getElementById('kycStatus').textContent = data.kycStatus || 'Pending';

      // Update activity table
      const table = document.getElementById('activityTable');
      const activity = data.transactions || data.transfers || [];
      
      if (activity.length > 0) {
        let activityHTML = `
          <tr>
            <th>Date</th>
            <th>Description</th>
            <th>Type</th>
            <th>Amount</th>
            <th>Status</th>
          </tr>
        `;
        
        activity.forEach(act => {
          const amount = act.amount || 0;
          const amountFormatted = formatCurrency(Math.abs(amount));
          const amountClass = amount >= 0 ? 'color: #006644;' : 'color: #d63031;';
          
          activityHTML += `
            <tr>
              <td>${act.initiatedAt ? new Date(act.initiatedAt).toLocaleDateString() : new Date(act.createdAt).toLocaleDateString()}</td>
              <td>${act.description || act.notes || 'Transaction'}</td>
              <td>${act.type || 'Transfer'}</td>
              <td style="${amountClass} font-weight: 600;">${amount >= 0 ? '+' : ''}${amountFormatted}</td>
              <td>${act.status || 'Completed'}</td>
            </tr>
          `;
        });
        
        table.innerHTML = activityHTML;
      } else {
        table.innerHTML = `
          <tr>
            <th>Date</th>
            <th>Description</th>
            <th>Type</th>
            <th>Amount</th>
            <th>Status</th>
          </tr>
          <tr>
            <td colspan="5" style="text-align: center; padding: 30px; color: #666;">
              No recent activity
            </td>
          </tr>
        `;
      }
    } else {
      showAlert(data.message || 'Failed to load overview data');
    }
  } catch (err) {
    console.error('Overview fetch error:', err);
    showAlert('Error connecting to server. Please try again.');
  }
}

// Load overview on page load
document.addEventListener('DOMContentLoaded', function() {
  const token = localStorage.getItem('metaBankToken');
  if (!token) {
    window.location.href = 'login.html';
    return;
  }
  
  loadOverview();
});
</script>

</body>
</html>