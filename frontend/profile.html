<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Meta Bank Profile</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background-color: #f4f6f9;
      display: flex;
      min-height: 100vh;
    }
    .sidebar {
      width: 250px;
      background-color: #006644;
      color: white;
      height: 100vh;
      padding: 20px;
      box-sizing: border-box;
      position: fixed;
      left: 0;
      top: 0;
    }
    .sidebar h2 {
      margin-top: 0;
      font-size: 1.5em;
      margin-bottom: 30px;
      text-align: center;
    }
    .sidebar a {
      display: block;
      color: white;
      text-decoration: none;
      margin-bottom: 15px;
      font-weight: 500;
      padding: 10px 15px;
      border-radius: 6px;
      transition: background-color 0.3s;
    }
    .sidebar a:hover { background-color: #004d33; text-decoration: none; }
    .sidebar a.active { background-color: #004d33; }

    .main {
      flex: 1;
      padding: 30px;
      background: linear-gradient(to bottom right, #ffffff, #e0f7e9);
      margin-left: 250px;
      width: calc(100% - 250px);
    }
    .greeting {
      font-size: 1.8em;
      margin-bottom: 20px;
      color: #006644;
      font-weight: 600;
    }

    .alert {
      padding: 12px 15px;
      border-radius: 6px;
      margin-bottom: 20px;
      text-align: center;
      font-weight: 500;
      display: none;
    }
    .alert-success { background: #e8f8ef; color: #006644; border: 1px solid #b8e6b8; }
    .alert-error { background: #ffeaea; color: #d63031; border: 1px solid #ffcccc; }

    .profile-card {
      background-color: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      max-width: 800px;
    }
    .profile-card h3 {
      margin-top: 0;
      color: #006644;
      font-size: 1.5em;
      margin-bottom: 25px;
      border-bottom: 2px solid #e0f7e9;
      padding-bottom: 10px;
    }

    .profile-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    .profile-item {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      border-left: 4px solid #006644;
    }
    .profile-label {
      font-size: 0.9em;
      color: #666;
      margin-bottom: 5px;
    }
    .profile-value {
      font-size: 1.1em;
      font-weight: 600;
      color: #333;
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.8em;
      font-weight: 600;
    }
    .badge-active { background-color: #e8f8ef; color: #006644; }
    .badge-pending { background-color: #fff3cd; color: #856404; }
    .badge-inactive { background-color: #ffeaea; color: #d63031; }

    .update-btn {
      margin-top: 25px;
      background-color: #006644;
      color: white;
      padding: 12px 24px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: background-color 0.3s;
    }
    .update-btn:hover { background-color: #004d33; }
  </style>
</head>
<body>

<div class="sidebar">
  <h2>Meta Bank</h2>
  <a href="dashboard.html">Dashboard</a>
  <a href="overview.html">Overview</a>
  <a href="verification.html">Verification</a>
  <a href="profile.html" class="active">Profile</a>
  <a href="loan.html">Loans</a>
  <a href="investments.html">Investments</a>
  <a href="ira.html">IRA</a>
  <a href="transfer.html">Transfer</a>
  <a href="external-accounts.html">External Accounts</a>
  <a href="statements.html">Statements</a>
  <a href="business-account.html">Business Account</a>
  <a href="#" id="signOutLink">Sign Out</a>
</div>

<div class="main">
  <div class="greeting" id="greeting">Loading profile...</div>
  <div id="alertMessage" class="alert"></div>

  <div class="profile-card">
    <h3>My Profile</h3>

    <div class="profile-grid">
      <div class="profile-item">
        <div class="profile-label">Full Name</div>
        <div class="profile-value" id="fullName">Loading...</div>
      </div>

      <div class="profile-item">
        <div class="profile-label">Username</div>
        <div class="profile-value" id="username">Loading...</div>
      </div>

      <div class="profile-item">
        <div class="profile-label">Email</div>
        <div class="profile-value" id="email">Loading...</div>
      </div>

      <div class="profile-item">
        <div class="profile-label">Phone</div>
        <div class="profile-value" id="phone">Loading...</div>
      </div>

      <div class="profile-item">
        <div class="profile-label">Date of Birth</div>
        <div class="profile-value" id="dob">Loading...</div>
      </div>

      <div class="profile-item">
        <div class="profile-label">Account Type</div>
        <div class="profile-value" id="accountType">Loading...</div>
      </div>

      <div class="profile-item">
        <div class="profile-label">Account Number</div>
        <div class="profile-value" id="accountNumber">Loading...</div>
      </div>

      <div class="profile-item">
        <div class="profile-label">Routing Number</div>
        <div class="profile-value" id="routingNumber">Loading...</div>
      </div>

      <div class="profile-item">
        <div class="profile-label">Account Balance</div>
        <div class="profile-value" id="balance">Loading...</div>
      </div>

      <div class="profile-item">
        <div class="profile-label">KYC Status</div>
        <div class="profile-value">
          <span id="kycText">Loading...</span>
          <span id="kycBadge" class="badge"></span>
        </div>
      </div>

      <div class="profile-item">
        <div class="profile-label">Account Status</div>
        <div class="profile-value">
          <span id="acctText">Loading...</span>
          <span id="acctBadge" class="badge"></span>
        </div>
      </div>

      <div class="profile-item">
        <div class="profile-label">Email Verification</div>
        <div class="profile-value">
          <span id="emailText">Loading...</span>
          <span id="emailBadge" class="badge"></span>
        </div>
      </div>
    </div>

    <button class="update-btn" id="updateBtn">Update Profile</button>
  </div>
</div>

<script>
// API Base URL (localhost in dev, /api in production)
const API_BASE =
  (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1')
    ? 'http://localhost:5000/api'
    : 'https://meta-bank-backend.onrender.com/api';

function showAlert(message, type = 'error') {
  const el = document.getElementById('alertMessage');
  el.textContent = message;
  el.className = `alert alert-${type}`;
  el.style.display = 'block';
  if (type === 'success') {
    setTimeout(() => { el.style.display = 'none'; }, 4000);
  }
}

function setBadge(el, status, kind) {
  // Normalize
  const s = String(status ?? '').toLowerCase();
  el.className = 'badge';
  el.textContent = '';

  if (kind === 'kyc') {
    if (s === 'approved' || s === 'verified') { el.classList.add('badge-active'); el.textContent = 'Verified'; }
    else if (s === 'pending') { el.classList.add('badge-pending'); el.textContent = 'Pending'; }
    else { el.classList.add('badge-inactive'); el.textContent = 'Required'; }
  } else if (kind === 'account') {
    if (s === 'active') { el.classList.add('badge-active'); el.textContent = 'Active'; }
    else { el.classList.add('badge-inactive'); el.textContent = 'Inactive'; }
  } else if (kind === 'email') {
    if (s === 'true' || s === 'verified' || s === 'yes') { el.classList.add('badge-active'); el.textContent = 'Verified'; }
    else { el.classList.add('badge-pending'); el.textContent = 'Pending'; }
  }
}

function formatUSD(amount) {
  return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount || 0);
}

document.getElementById('signOutLink').addEventListener('click', (e) => {
  e.preventDefault();
  localStorage.clear();
  window.location.href = 'login.html';
});

document.getElementById('updateBtn').addEventListener('click', () => {
  showAlert('Profile update feature coming soon!', 'success');
});

async function loadProfile() {
  const token = localStorage.getItem('metaBankToken');
  if (!token) {
    showAlert('Session expired. Please log in again.');
    setTimeout(() => window.location.href = 'login.html', 1500);
    return;
  }

  try {
    const res = await fetch(`${API_BASE}/auth/profile`, {
      headers: {
        'Authorization': 'Bearer ' + token,
        'Content-Type': 'application/json'
      }
    });
    const data = await res.json();

    if (!res.ok || !data.success) {
      showAlert(data.message || 'Failed to load profile');
      return;
    }

    const user = data.user || {};
    document.getElementById('greeting').textContent = `Welcome â€“ ${user.fullName || user.username || 'User'}`;

    document.getElementById('fullName').textContent = user.fullName || 'N/A';
    document.getElementById('username').textContent = user.username || 'N/A';
    document.getElementById('email').textContent = user.email || 'N/A';
    document.getElementById('phone').textContent = user.phone || 'N/A';
    document.getElementById('dob').textContent = user.dob ? new Date(user.dob).toLocaleDateString() : 'N/A';

    const acctTypeText = user.accountType
      ? user.accountType.charAt(0).toUpperCase() + user.accountType.slice(1)
      : 'Checking';
    document.getElementById('accountType').textContent = acctTypeText;

    document.getElementById('accountNumber').textContent = user.accountNumber || 'Not assigned';
    document.getElementById('routingNumber').textContent = user.routingNumber || 'N/A';
    document.getElementById('balance').textContent = formatUSD(user.balance);

    // Status text + badges
    const kycStatus = user.kycStatus || 'pending';
    const accountStatus = user.accountStatus || 'inactive';
    const emailVerified = user.isVerified ? 'verified' : 'pending';

    document.getElementById('kycText').textContent = kycStatus;
    document.getElementById('acctText').textContent = accountStatus;
    document.getElementById('emailText').textContent = user.isVerified ? 'Verified' : 'Pending';

    setBadge(document.getElementById('kycBadge'), kycStatus, 'kyc');
    setBadge(document.getElementById('acctBadge'), accountStatus, 'account');
    setBadge(document.getElementById('emailBadge'), emailVerified, 'email');

  } catch (err) {
    console.error('Profile fetch error:', err);
    showAlert('Error connecting to server');
  }
}

document.addEventListener('DOMContentLoaded', loadProfile);
</script>
</body>
</html>
